<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; -webkit-text-stroke: #000000; min-height: 16.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE html&gt;</span></p>
<p class="p1"><span class="s1">&lt;html lang="en" class="dark"&gt;</span></p>
<p class="p1"><span class="s1">&lt;head&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;title&gt;Grading Sheet v3&lt;/title&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.tailwindcss.com"&gt;&lt;/script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.jsdelivr.net/npm/chart.js"&gt;&lt;/script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;script type="module"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// Import the functions you need from the SDKs you need</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// Your web app's Firebase configuration</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const firebaseConfig = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>apiKey: "AIzaSyCgKrY0BRmcPJx3Vc32vWaSPWPBlCfBuSQ",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>authDomain: "grading-sheet-app.firebaseapp.com",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>projectId: "grading-sheet-app",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>storageBucket: "grading-sheet-app.firebasestorage.app",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>messagingSenderId: "1051043442687",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>appId: "1:1051043442687:web:05952327e6bcfb2281c1ca",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>measurementId: "G-XEG8PD20QG"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const appId = firebaseConfig.projectId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>window.firebase = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, updateDoc, deleteDoc, runTransaction</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>window.firebaseConfig = firebaseConfig;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>window.appId = appId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>window.initialAuthToken = initialAuthToken;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>window.setLogLevel = setLogLevel;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setLogLevel('debug');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;style&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>body {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>font-family: 'Inter', sans-serif;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>background-color: #020617; /* slate-950 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>color: #e2e8f0; /* slate-200 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.card {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>background-color: #0f172a; /* slate-900 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border: 1px solid #1e293b; /* slate-800 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>input, select {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>background-color: #1e293b; /* slate-800 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border: 1px solid #334155; /* slate-700 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>color: #e2e8f0; /* slate-200 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border-radius: 0.375rem;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>transition: all 0.2s ease-in-out;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>input:focus, select:focus {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>outline: 2px solid #4f46e5;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>outline-offset: 2px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border-color: #4f46e5;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>input::placeholder { color: #94a3b8; /* slate-400 */ }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>input[type="number"]::-webkit-inner-spin-button,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>input[type="number"] { -moz-appearance: textfield; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.tab-button.active { background-color: #4f46e5; color: white; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.tab-button:not(.active) { background-color: #1e293b; color: #94a3b8; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>details &gt; summary { list-style: none; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>details &gt; summary::-webkit-details-marker { display: none; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>details &gt; summary .summary-arrow { transition: transform 0.2s; display: inline-block; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>details[open] &gt; summary .summary-arrow { transform: rotate(90deg); }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.table-container::-webkit-scrollbar { height: 8px; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.table-container::-webkit-scrollbar-track { background: #1e293b; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.table-container::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.sticky-col { position: sticky; left: 0; z-index: 10; background-color: #0f172a; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.sticky-header { position: sticky; top: 0; z-index: 20; background-color: #1e293b; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>/* Ensure all cells in score table have borders */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#score-input-table table, #score-input-table th, #score-input-table td {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border: 1px solid #1e293b; /* slate-800 */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#score-input-table table {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border-collapse: collapse; /* Ensure borders collapse */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#score-input-table thead th.sticky-col { z-index: 30; background-color: #1e293b;}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.disabled-section { pointer-events: none; opacity: 0.5; position: relative; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.disabled-overlay {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>position: absolute; top: 0; left: 0; width: 100%; height: 100%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>background-color: rgba(2, 6, 23, 0.7);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>display: flex; align-items: center; justify-content: center;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>font-weight: bold; font-size: 1.1rem; color: #94a3b8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>text-align: center; border-radius: 0.5rem; z-index: 40;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>/* Toast Notification */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#toast {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>position: fixed;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bottom: -100px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>left: 50%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>transform: translateX(-50%);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>padding: 1rem 1.5rem;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border-radius: 0.5rem;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>color: white;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>font-weight: 500;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>box-shadow: 0 4px 15px rgba(0,0,0,0.2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>transition: bottom 0.5s ease-in-out;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>z-index: 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#toast.show { bottom: 20px; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#toast.success { background-color: #10b981; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#toast.error { background-color: #ef4444; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>#toast.info { background-color: #3b82f6; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>/* Print Styles */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>@media print {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>body * { visibility: hidden; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>#printable-area, #printable-area * { visibility: visible; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>#printable-area { position: absolute; left: 0; top: 0; width: 100%; color: black; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>.table-container { overflow: visible; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>.print-bg-white { background-color: white !important; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.loading-overlay {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>position: fixed;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>top: 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>left: 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>width: 100%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>height: 100%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>background-color: rgba(0, 0, 0, 0.7);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>display: flex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>align-items: center;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>justify-content: center;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>z-index: 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>color: white;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>flex-direction: column;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>gap: 1rem;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>font-size: 1.2rem;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>.spinner {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border: 4px solid rgba(255, 255, 255, 0.3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border-top: 4px solid #fff;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>border-radius: 50%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>width: 40px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>height: 40px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>animation: spin 1s linear infinite;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>@keyframes spin {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>0% { transform: rotate(0deg); }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>100% { transform: rotate(360deg); }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</span></p>
<p class="p1"><span class="s1">&lt;/head&gt;</span></p>
<p class="p1"><span class="s1">&lt;body&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="loading-overlay" class="loading-overlay hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="spinner"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;p id="loading-text"&gt;Loading...&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;header class="max-w-7xl mx-auto mb-8 flex justify-between items-center print:hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="flex items-center gap-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;img id="school-logo" src="https://placehold.co/64x64/1e293b/e2e8f0?text=Logo" alt="School Logo" class="w-16 h-16 rounded-lg object-cover shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h1 class="text-3xl font-bold text-indigo-400"&gt;Grading Sheet&lt;/h1&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;p class="text-slate-400"&gt;A real-time collaborative grading tool.&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;button id="how-to-use-button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2" onclick="showHowToUseModal()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"&gt;&lt;circle cx="12" cy="12" r="10"/&gt;&lt;path d="M12 16v-4"/&gt;&lt;path d="M12 8h.01"/&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>How to Use</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;button id="reset-course-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors flex items-center gap-2" onclick="showResetConfirmationModal()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"&gt;&lt;path d="M3 6h18"/&gt;&lt;path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/&gt;&lt;path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/&gt;&lt;line x1="10" y1="11" x2="10" y2="17"/&gt;&lt;line x1="14" y1="11" x2="14" y2="17"/&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>Reset Course</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;button id="admin-view-button" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-slate-800 hover:bg-slate-700 transition-colors" onclick="showAdminPasswordModal()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"&gt;&lt;path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"&gt;&lt;/path&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;button id="settings-button" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-slate-800 hover:bg-slate-700 transition-colors" onclick="showSettingsModal()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;circle cx="12" cy="12" r="3"&gt;&lt;/circle&gt;&lt;path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"&gt;&lt;/path&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/header&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="max-w-7xl mx-auto space-y-8"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg card print:hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h2 class="text-xl font-semibold mb-4"&gt;1. Select Academic Period&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="grid grid-cols-1 sm:grid-cols-2 gap-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;label for="select-academic-year" class="block text-sm font-medium text-slate-400 mb-1"&gt;Academic Year&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;select id="select-academic-year" class="p-2 w-full" onchange="updateAcademicYearSelection()"&gt;&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;label for="select-semester" class="block text-sm font-medium text-slate-400 mb-1"&gt;Semester&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;select id="select-semester" class="p-2 w-full" onchange="updateSemesterSelection()"&gt;&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div id="academic-period-status" class="p-3 rounded-md text-center font-medium mt-4 hidden"&gt;Please select both Academic Year and Semester.&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="grid grid-cols-1 md:grid-cols-2 gap-6 print:hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;details class="p-6 rounded-lg card" open&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;summary class="text-xl font-semibold cursor-pointer flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;span class="summary-arrow"&gt;▶&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"&gt;&lt;/path&gt;&lt;path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"&gt;&lt;/path&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>2. Select Course</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/summary&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div id="course-selection-section" class="mt-6 p-4 rounded-md border space-y-3 card disabled-section"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="course-selection-overlay" class="disabled-overlay"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;span&gt;Please select an Academic Year and Semester above.&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="grid grid-cols-1 sm:grid-cols-3 gap-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label for="select-subject" class="block text-sm font-medium text-slate-400 mb-1"&gt;Subject&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;select id="select-subject" class="p-2 w-full" onchange="updateCourseSelection()"&gt;&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label for="select-grade-level" class="block text-sm font-medium text-slate-400 mb-1"&gt;Grade Level&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;select id="select-grade-level" class="p-2 w-full" onchange="updateCourseSelection()"&gt;&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label for="select-room" class="block text-sm font-medium text-slate-400 mb-1"&gt;Room&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;select id="select-room" class="p-2 w-full" onchange="updateCourseSelection()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value=""&gt;Select Room&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="A"&gt;A&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="B"&gt;B&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="C"&gt;C&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="D"&gt;D&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="E"&gt;E&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="F"&gt;F&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="course-selection-status" class="p-3 rounded-md text-center font-medium hidden"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/details&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;details class="p-6 rounded-lg card" open&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;summary class="text-xl font-semibold cursor-pointer flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;span class="summary-arrow"&gt;▶&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"&gt;&lt;/path&gt;&lt;circle cx="12" cy="7" r="4"&gt;&lt;/circle&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>3. Teacher Info</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/summary&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div id="teacher-info-container" class="mt-6 p-4 rounded-md border space-y-3 card disabled-section"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="teacher-info-container-overlay" class="disabled-overlay"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;span&gt;Please select a Course above.&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="teacher-info-display" class="hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-lg font-semibold text-white" id="display-teacher-name"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-slate-400" id="display-teacher-id"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex gap-2 mt-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button id="edit-teacher-info-button" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 transition-colors flex items-center justify-center gap-2" onclick="editTeacherInfo()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"&gt;&lt;path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/&gt;&lt;path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>Edit Info</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button id="delete-teacher-info-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-2" onclick="showDeleteTeacherConfirmation()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"&gt;&lt;path d="M3 6h18"/&gt;&lt;path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/&gt;&lt;path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/&gt;&lt;line x1="10" y1="11" x2="10" y2="17"/&gt;&lt;line x1="14" y1="11" x2="14" y2="17"/&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>Delete Info</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="teacher-info-edit-form"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="grid grid-cols-1 sm:grid-cols-2 gap-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label for="teacher-real-name" class="block text-sm font-medium text-slate-400 mb-1"&gt;Full Name &lt;span class="text-red-500"&gt;*&lt;/span&gt;&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;input type="text" id="teacher-real-name" placeholder="Enter your full name" class="p-2 w-full teacher-info-input" oninput="checkTeacherFormValidity()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label for="teacher-id" class="block text-sm font-medium text-slate-400 mb-1"&gt;Teacher ID&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;input type="text" id="teacher-id" placeholder="Enter your ID" class="p-2 w-full teacher-info-input"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button id="save-teacher-info-button" onclick="saveTeacherInfo()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:bg-indigo-800 disabled:text-slate-400 transition-colors flex items-center justify-center gap-2 mt-3" disabled&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"&gt;&lt;path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/&gt;&lt;polyline points="17 21 17 13 7 13 7 21"/&gt;&lt;polyline points="7 3 7 8 15 8"/&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>Save Info</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p id="save-teacher-hint" class="text-sm text-yellow-400 mt-2 hidden text-center"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>Click 'Save Info' to apply changes and unlock other sections.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/details&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div id="main-content-area" class="disabled-section"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div id="main-content-overlay" class="disabled-overlay"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;span&gt;Please select an Academic Year, Semester, and Course, then save your Teacher Info to continue.&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;details class="p-6 rounded-lg card" open&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;summary class="text-xl font-semibold cursor-pointer flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;span class="summary-arrow"&gt;▶&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;polygon points="12 2 2 7 12 12 22 7 12 2"&gt;&lt;/polygon&gt;&lt;polyline points="2 17 12 22 22 17"&gt;&lt;/polyline&gt;&lt;polyline points="2 12 12 17 22 12"&gt;&lt;/polyline&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>4. Setup Grading Components</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/summary&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="mt-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h3 class="font-semibold text-lg mb-3"&gt;1. Manage Assessment Components (e.g., Projects &amp; Presentations, Long Test)&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="p-4 rounded-md border space-y-3 card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div id="grading-period-list" class="space-y-2"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex flex-col sm:flex-row gap-4 mt-3 border-t pt-4 border-slate-800"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="new-grading-period-name" placeholder="New Component Name (e.g., Projects)" class="flex-grow p-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="number" id="new-grading-period-weight" placeholder="Weight (%)" class="w-full sm:w-32 p-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="addGradingPeriod()" class="bg-blue-600 text-white px-5 py-3 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;line x1="12" y1="5" x2="12" y2="19"&gt;&lt;/line&gt;&lt;line x1="5" y1="12" x2="19" y2="12"&gt;&lt;/line&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>Add Component</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-right mt-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p id="total-grading-period-weight-info" class="font-medium"&gt;Total Component Weight: &lt;span id="current-total-grading-period-weight"&gt;0&lt;/span&gt;%&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p id="grading-period-warning" class="text-red-500 font-medium hidden"&gt;⚠️ Total component weight must be 100%&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h3 class="font-semibold text-lg mt-6 mb-3"&gt;2. Select Assessment Component to Manage Categories&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="p-4 rounded-md border space-y-3 card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;select id="select-grading-period" class="p-2 w-full" onchange="selectGradingPeriod()"&gt;&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div id="selected-grading-period-status" class="p-3 rounded-md text-center font-medium hidden"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h3 class="font-semibold text-lg mt-6 mb-3"&gt;3. Manage Categories within &lt;span id="current-period-name" class="text-indigo-300"&gt;Selected Assessment Component&lt;/span&gt;&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="category-management-section" class="disabled-section"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div id="category-management-overlay" class="disabled-overlay"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;span&gt;Please select an Assessment Component above to manage categories.&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div id="category-settings" class="space-y-4"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex flex-col sm:flex-row gap-4 mt-6 border-t pt-4 border-slate-800"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="new-category-name" placeholder="New Category Name (e.g., Homework)" class="flex-grow p-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="number" id="new-category-weight" placeholder="Weight (%)" class="w-full sm:w-32 p-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="addCategory()" class="bg-blue-600 text-white px-5 py-3 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;line x1="12" y1="5" x2="12" y2="19"&gt;&lt;/line&gt;&lt;line x1="5" y1="12" x2="19" y2="12"&gt;&lt;/line&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>Add Category</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex flex-col sm:flex-row gap-4 mt-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="file" id="category-csv-file-input" accept=".csv" class="hidden" onchange="handleCategoryCsvImport(event)"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="document.getElementById('category-csv-file-input').click()" class="w-full bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600 transition-colors flex items-center justify-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"&gt;&lt;/path&gt;&lt;polyline points="17 8 12 3 7 8"&gt;&lt;/polyline&gt;&lt;line x1="12" y1="3" x2="12" y2="15"&gt;&lt;/line&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>Import Categories (CSV)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-slate-400 mt-2"&gt;Format: `categoryName,weight` (e.g., `Participation,10`)&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-right mt-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p id="total-category-weight-info" class="font-medium"&gt;Total Category Weight: &lt;span id="current-total-category-weight"&gt;0&lt;/span&gt;%&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p id="category-weight-warning" class="text-red-500 font-medium hidden"&gt;⚠️ Total category weight must be 100% within this component&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/details&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;details class="p-6 rounded-lg card" open&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;summary class="text-xl font-semibold cursor-pointer flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;span class="summary-arrow"&gt;▶&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"&gt;&lt;/path&gt;&lt;circle cx="9" cy="7" r="4"&gt;&lt;/circle&gt;&lt;path d="M23 21v-2a4 4 0 0 0-3-3.87"&gt;&lt;/path&gt;&lt;path d="M16 3.13a4 4 0 0 1 0 7.75"&gt;&lt;/path&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>5. Student Management</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/summary&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="p-4 rounded-md border space-y-3 card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h3 class="font-semibold text-lg"&gt;Add New Student&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="grid grid-cols-2 gap-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="new-student-real-name" placeholder="Full Name" class="p-2 col-span-2 new-student-input" oninput="checkAddStudentFormValidity()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="new-student-nickname" placeholder="Nickname" class="p-2 col-span-2 new-student-input"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" id="new-student-id" placeholder="Student ID" class="p-2 new-student-input" oninput="checkAddStudentFormValidity()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="number" id="new-student-roll-number" placeholder="Roll Number" class="p-2 new-student-input" oninput="checkAddStudentFormValidity()"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button id="add-student-button" onclick="addStudent()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-green-800 disabled:text-slate-400 transition-colors flex items-center justify-center gap-2" disabled&gt;Add Student&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="p-4 rounded-md border flex flex-col items-center justify-center text-center card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h3 class="font-semibold text-lg"&gt;Import from CSV&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-slate-400 my-2"&gt;Format: `studentId,realName,nickname,rollNumber`&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-slate-400 my-2"&gt;(Grade &amp; Room are based on current selection)&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;input type="file" id="csv-file-input" accept=".csv" class="hidden" onchange="handleCsvImport(event)"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="document.getElementById('csv-file-input').click()" class="w-full bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600 transition-colors flex items-center justify-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"&gt;&lt;/path&gt;&lt;polyline points="17 8 12 3 7 8"&gt;&lt;/polyline&gt;&lt;line x1="12" y1="3" x2="12" y2="15"&gt;&lt;/line&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>Choose .csv File</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div id="student-list" class="mt-6 space-y-2"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/details&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div id="printable-area" class="print-bg-white"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-center border-b border-slate-800 mb-6 print:hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="score-entry-tab" class="tab-button active px-6 py-3 text-lg font-medium rounded-t-lg" onclick="showTab('score-entry')"&gt;Score Entry ✏️&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="summary-tab" class="tab-button px-6 py-3 text-lg font-medium rounded-t-lg" onclick="showTab('summary')"&gt;Summary &amp; Reports 🏆&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div id="score-entry-section"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="flex justify-between items-center mb-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-semibold"&gt;Enter Student Scores&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="window.print()" class="bg-slate-500 text-white px-4 py-2 rounded-md hover:bg-slate-600 transition-colors print:hidden flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;polyline points="6 9 6 2 18 2 18 9"&gt;&lt;/polyline&gt;&lt;path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"&gt;&lt;/path&gt;&lt;rect x="6" y="14" width="12" height="8"&gt;&lt;/rect&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>Print Table</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="score-input-table" class="table-container overflow-x-auto"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p id="score-entry-info" class="text-slate-400 mt-4 text-center hidden"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div id="summary-section" class="hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="flex flex-wrap justify-between items-center mb-4 gap-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-semibold"&gt;Score Summary &amp; Analysis&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="exportScoresToCsv()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors print:hidden flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"&gt;&lt;path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/&gt;&lt;polyline points="7 10 12 15 17 10"/&gt;&lt;line x1="12" y1="15" x2="12" y2="3"/&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>Export CSV</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="window.print()" class="bg-slate-500 text-white px-4 py-2 rounded-md hover:bg-slate-600 transition-colors print:hidden flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;polyline points="6 9 6 2 18 2 18 9"&gt;&lt;/polyline&gt;&lt;path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"&gt;&lt;/path&gt;&lt;rect x="6" y="14" width="12" height="8"&gt;&lt;/rect&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>Print Summary</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="advanced-dashboard" class="mb-8 p-6 rounded-lg shadow-inner border card print:hidden"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-semibold mb-4"&gt;Student Performance Overview&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="grid grid-cols-1 lg:grid-cols-2 gap-8"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="relative h-80"&gt;&lt;canvas id="student-group-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="grid grid-cols-1 md:grid-cols-3 gap-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;div class="p-3 bg-green-900/50 rounded-lg"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;h5 class="font-bold text-green-300 text-center"&gt;Excellent (&gt;=70%)&lt;/h5&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;ul id="group-excellent" class="mt-2 text-sm text-green-400 list-disc list-inside"&gt;&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;div class="p-3 bg-yellow-900/50 rounded-lg"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;h5 class="font-bold text-yellow-300 text-center"&gt;Average (50-69%)&lt;/h5&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;ul id="group-average" class="mt-2 text-sm text-yellow-400 list-disc list-inside"&gt;&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;div class="p-3 bg-red-900/50 rounded-lg"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;h5 class="font-bold text-red-300 text-center"&gt;Needs Improvement (&lt;50%)&lt;/h5&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;ul id="group-improvement" class="mt-2 text-sm text-red-400 list-disc list-inside"&gt;&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="summary-table" class="table-container overflow-x-auto"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p id="summary-info" class="text-slate-400 mt-4 text-center"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-sm w-full card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h3 id="alert-title" class="text-xl font-semibold mb-4"&gt;Notification&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;p id="alert-message" class="mb-6 text-slate-300"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideAlert()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700"&gt;OK&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-md w-full card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h3 class="text-xl font-semibold mb-4 flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"&gt;&lt;circle cx="12" cy="12" r="3"&gt;&lt;/circle&gt;&lt;path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"&gt;&lt;/path&gt;&lt;/svg&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>Settings</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="space-y-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;label for="settings-logo-url" class="block text-sm font-medium text-slate-400"&gt;School Logo URL&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;input type="url" id="settings-logo-url" placeholder="Paste image URL here" class="mt-1 p-2 w-full"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end gap-2 mt-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideSettingsModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button id="save-settings-button" onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"&gt;Save&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="admin-password-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-sm w-full card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h3 class="text-xl font-semibold mb-4"&gt;Admin Access&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;p class="text-slate-400 mb-4"&gt;Please enter the admin password to view the dashboard.&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;label for="admin-password-input" class="block text-sm font-medium text-slate-400"&gt;Password&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;input type="password" id="admin-password-input" class="mt-1 p-2 w-full"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end gap-2 mt-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideAdminPasswordModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="checkAdminPassword()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"&gt;Enter&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="reset-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-sm w-full card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h3 class="text-xl font-semibold mb-4 text-red-400"&gt;Confirm Reset&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;p class="text-slate-300 mb-4"&gt;This will clear all categories and teacher information for the currently selected course, and remove all associated scores from students for this course.&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;p class="text-slate-300 mb-4 font-bold"&gt;Please enter the password "HASTIN" to confirm:&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;label for="reset-password-input" class="block text-sm font-medium text-slate-400"&gt;Password&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;input type="password" id="reset-password-input" class="mt-1 p-2 w-full" placeholder="Enter HASTIN"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end gap-2 mt-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideResetConfirmationModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="confirmResetCourse()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"&gt;Confirm Reset&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="admin-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-4xl w-full h-[90vh] flex flex-col card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-between items-center mb-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h3 class="text-2xl font-bold"&gt;Admin Dashboard: All Courses Overview&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideAdminDashboardModal()" class="text-slate-400 hover:text-white text-3xl font-bold"&gt;&amp;times;&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div id="admin-dashboard-content" class="flex-grow overflow-y-auto space-y-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="score-breakdown-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-lg w-full card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h3 id="score-breakdown-modal-title" class="text-xl font-semibold mb-4"&gt;&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div id="score-breakdown-content" class="space-y-3 mb-6"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideScoreBreakdownModal()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700"&gt;Close&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-sm w-full card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;h3 id="confirmation-title" class="text-xl font-semibold mb-4 text-red-400"&gt;Confirm Action&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;p id="confirmation-message" class="mb-6 text-slate-300"&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideConfirmationModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button id="confirm-action-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"&gt;Confirm&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="how-to-use-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="p-6 rounded-lg shadow-xl max-w-2xl w-full h-[90vh] flex flex-col card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-between items-center mb-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h3 class="text-2xl font-bold"&gt;How to Use Grading Sheet&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideHowToUseModal()" class="text-slate-400 hover:text-white text-3xl font-bold"&gt;&amp;times;&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex-grow overflow-y-auto text-slate-300 space-y-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;p&gt;Welcome to the Grading Sheet application! Follow these steps to set up your courses, manage students, enter scores, and view reports.&lt;/p&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h4 class="text-xl font-semibold text-indigo-400"&gt;Step-by-Step Guide:&lt;/h4&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;ol class="list-decimal list-inside space-y-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;1. Select Academic Period:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Choose the **Academic Year** (current year + 10 years ahead) and **Semester** (Term 1, Term 2, Term 3).&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;&lt;span class="text-red-400"&gt;This is mandatory.&lt;/span&gt; The rest of the app will be disabled until both are selected.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;2. Select Course:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Select the **Subject**, **Grade Level**, and **Room** for your course.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;If it's a new combination, a new course will be created. If it exists, it will be loaded.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;3. Teacher Info:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Enter your **Full Name** (required) and **Teacher ID**.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Click **"Save Info"**. Once saved, the form will hide, and "Edit Info" / "Delete Info" buttons will appear.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;You can also set a **School Logo URL** in the Settings modal (top right gear icon).&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;4. Setup Grading Components:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;&lt;strong&gt;Manage Assessment Components:&lt;/strong&gt; Add your main assessment components (e.g., "Midterm Exam", "Final Project") with their overall weight (e.g., 30%, 70%). The total weight for all components must be 100%.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;&lt;strong&gt;Select Assessment Component to Manage Categories:&lt;/strong&gt; Choose one of your main components to define its sub-categories.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;&lt;strong&gt;Manage Categories within [Selected Component]:&lt;/strong&gt; Add **Categories** (e.g., "Quizzes", "Homework") within the selected component. Each category also has a weight. The total weight of categories within a component must be 100%.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;You can add **Sub-items** (e.g., "Quiz 1", "HW 2") to each category, each with its own max score.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Use the **"Import Categories (CSV)"** button to quickly add multiple categories. Format: `categoryName,weight` (e.g., `Participation,10`)&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;5. Student Management:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Add new students manually by filling in their details.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Use **"Import from CSV"** to add multiple students. Format: `studentId,realName,nickname,rollNumber` (e.g., `S001,John Doe,Johnny,1`).&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;You can **Edit** or **Delete** students from the list. Deleting requires confirmation.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;Score Entry &amp; Summary:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Switch between **"Score Entry"** tab to input scores for each student in the detailed table. Press `Enter` to move to the next input field.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;Go to **"Summary &amp; Reports"** tab to see overall scores, grades, and performance breakdowns (Excellent, Average, Needs Improvement).&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;The **Admin Dashboard** (shield icon in header) provides an overview of all courses and teacher progress.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-white"&gt;&lt;strong&gt;Reset Course:&lt;/strong&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;ul class="list-disc list-inside ml-4 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;li&gt;The **"Reset Course"** button (trash icon) will clear all data for the currently selected course. This requires a password for confirmation.&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/ul&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/li&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/ol&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;p&gt;All your data is saved in real-time to the cloud! Enjoy using the Grading Sheet!&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-end mt-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button onclick="hideHowToUseModal()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700"&gt;Got it!&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div id="toast" class=""&gt;&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- GLOBAL STATE &amp; CONSTANTS ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let db, auth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let userId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let courses = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let students = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let activeCourse = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let selectedAcademicYear = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let selectedSemester = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let selectedAssessmentComponent = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let studentGroupChartInstance = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let editingCategoryIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let originalCategoryState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let editingAssessmentComponentIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let originalAssessmentComponentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let editingStudentId = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let originalStudentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let currentConfirmCallback = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let isFirebaseReady = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let isFirstLoad = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let coursesUnsubscribe, studentsUnsubscribe;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// Colors for category headers in tables</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const tableHeaderColors = ['#1e3a8a', '#064e3b', '#78350f', '#991b1b', '#5b21b6'];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// List of available subjects</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const subjectsList = ['English', 'Maths', 'Science', 'Thai', 'ICT', 'Global Skills', 'ART', 'Sport Club', 'Geography', 'Music', 'Wellbeing', 'History', 'Data Literacy', 'Reading &amp; Presentation', 'Problem Solving', 'Chinese', 'Writing', 'Presentation'];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// List of available grade levels</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const gradeLevelsList = Array.from({ length: 13 }, (_, i) =&gt; `Y${i + 1}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- Firebase Initialization and Data Fetching ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function initializeFirebase() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof window.firebase === 'undefined' || !window.firebaseConfig) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error('Firebase SDK or config not loaded.');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('loading-text').textContent = "Initialization failed. Please refresh the page.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot, query, where } = window.firebase;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const { firebaseConfig, appId, initialAuthToken } = window;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showLoading("Initializing Firebase...");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const app = initializeApp(firebaseConfig);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>auth = getAuth(app);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>db = getFirestore(app);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const authReady = new Promise(resolve =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const unsubscribe = onAuthStateChanged(auth, async (user) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (user) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>userId = user.uid;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>showToast(`Signed in as: ${userId}`, 'info', 2000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>isFirebaseReady = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>unsubscribe();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>resolve();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (initialAuthToken) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>signInWithCustomToken(auth, initialAuthToken).catch(error =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>console.error("Custom token sign-in failed, signing in anonymously.", error);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>signInAnonymously(auth);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>signInAnonymously(auth);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await authReady;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await setupFirestoreListeners();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideLoading();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Firebase initialization failed:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('loading-text').textContent = "Error during initialization. Check console for details.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to initialize Firebase.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideLoading();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function setupFirestoreListeners() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!db || !userId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Firestore DB or userId not available.");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// Unsubscribe from previous listeners to prevent memory leaks</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (coursesUnsubscribe) coursesUnsubscribe();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentsUnsubscribe) studentsUnsubscribe();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const coursesRef = window.firebase.collection(db, `/artifacts/${window.appId}/public/data/courses`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsRef = window.firebase.collection(db, `/artifacts/${window.appId}/public/data/students`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showLoading("Fetching data...");</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// Courses Listener</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>coursesUnsubscribe = onSnapshot(coursesRef, (snapshot) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const tempCourses = snapshot.docs.map(doc =&gt; ({ id: doc.id, ...doc.data() }));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>courses = tempCourses;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (isFirstLoad) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>restoreUIState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>updateUIFromData();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}, (error) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error listening to courses:", error);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Error fetching course data.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideLoading();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// Students Listener</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>studentsUnsubscribe = onSnapshot(studentsRef, (snapshot) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const tempStudents = snapshot.docs.map(doc =&gt; ({ id: doc.id, ...doc.data() }));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>students = tempStudents;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (isFirstLoad) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>restoreUIState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>updateUIFromData();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}, (error) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error listening to students:", error);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Error fetching student data.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideLoading();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showLoading(message) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('loading-text').textContent = message;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('loading-overlay').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideLoading() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('loading-overlay').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- UI State Restoration and Update ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function restoreUIState() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>populateDropdowns();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const storedAcademicYear = localStorage.getItem('selectedAcademicYear');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const storedSemester = localStorage.getItem('selectedSemester');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const storedSubject = localStorage.getItem('selectedSubject');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const storedGrade = localStorage.getItem('selectedGrade');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const storedRoom = localStorage.getItem('selectedRoom');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (storedAcademicYear) document.getElementById('select-academic-year').value = storedAcademicYear;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (storedSemester) document.getElementById('select-semester').value = storedSemester;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (storedSubject) document.getElementById('select-subject').value = storedSubject;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (storedGrade) document.getElementById('select-grade-level').value = storedGrade;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (storedRoom) document.getElementById('select-room').value = storedRoom;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCourseSelection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>isFirstLoad = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hideLoading();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateUIFromData() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const newActiveCourse = courses.find(c =&gt; c.id === activeCourse.id);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse = newActiveCourse;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (selectedAssessmentComponent &amp;&amp; activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>selectedAssessmentComponent = activeCourse.assessmentComponents.find(p =&gt; p.id === selectedAssessmentComponent.id);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAll();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hideLoading();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// Helper function to format numbers (remove .00 if integer)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function formatNumber(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const num = parseFloat(value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isNaN(num) || !isFinite(num)) return 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (num === Math.floor(num)) return num.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return num.toFixed(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- UTILITY FUNCTIONS ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function showToast(message, type = 'success', duration = 3000) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const toast = document.getElementById('toast');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>toast.textContent = message;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>toast.className = ``;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>toast.classList.add(type, 'show');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setTimeout(() =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>toast.classList.remove('show');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}, duration);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showAlert(title, message) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('alert-title').textContent = title;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('alert-message').textContent = message;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('alert-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideAlert() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('alert-modal').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showConfirmationModal(title, message, onConfirmCallback) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('confirmation-title').textContent = title;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('confirmation-message').textContent = message;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currentConfirmCallback = onConfirmCallback;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('confirmation-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideConfirmationModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('confirmation-modal').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currentConfirmCallback = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>document.getElementById('confirm-action-button').addEventListener('click', () =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (currentConfirmCallback) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currentConfirmCallback();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hideConfirmationModal();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showResetConfirmationModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showAlert("Action Required", "Please select a course before attempting to reset its data.");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('reset-password-input').value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('reset-confirmation-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideResetConfirmationModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('reset-confirmation-modal').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function confirmResetCourse() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const passwordInput = document.getElementById('reset-password-input').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (passwordInput === "HASTIN") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await resetCourseData();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideResetConfirmationModal();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showAlert("Error", "Incorrect password.");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('reset-password-input').value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showAdminPasswordModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('admin-password-input').value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('admin-password-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideAdminPasswordModal() { document.getElementById('admin-dashboard-modal').classList.add('hidden'); }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showSettingsModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('settings-logo-url').value = activeCourse?.teacher?.logoUrl || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('settings-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showHowToUseModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('how-to-use-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideHowToUseModal() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('how-to-use-modal').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showScoreBreakdownModal(studentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const student = students.find(s =&gt; s.studentId === studentId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!student || !activeCourse) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('score-breakdown-modal-title').textContent = `Score Details for ${student.realName}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const contentDiv = document.getElementById('score-breakdown-content');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>contentDiv.innerHTML = activeCourse.assessmentComponents.map(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let componentHtml = `&lt;div class="p-2 border rounded-md bg-slate-700 border-slate-500 mb-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-bold text-indigo-300"&gt;${component.name} (${component.weight}%)&lt;/p&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (component.categories &amp;&amp; component.categories.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>componentHtml += `&lt;ul class="list-disc list-inside ml-4 text-sm space-y-1"&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const { current, max } = getCategoryScores(student, component.name, cat, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const percentage = max &gt; 0 ? (current / max) * 100 : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>componentHtml += `&lt;li&gt;${cat.name} (${cat.weight}% of Component): ${formatNumber(current)}/${formatNumber(max)} (${formatNumber(percentage)}%)`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>componentHtml += `&lt;ul class="list-circle list-inside ml-4 text-xs"&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>cat.subItems.forEach(sub =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>const subScore = student.scores[activeCourse.id]?.[component.name]?.[cat.name]?.[sub.id] || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>componentHtml += `&lt;li&gt;${sub.name}: ${formatNumber(subScore)}/${formatNumber(sub.maxScore)}&lt;/li&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>componentHtml += `&lt;/ul&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>componentHtml += `&lt;/li&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>componentHtml += `&lt;/ul&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>componentHtml += `&lt;p class="text-slate-400 text-xs ml-4"&gt;No categories defined for this component.&lt;/p&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return componentHtml + `&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).join('');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('score-breakdown-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideScoreBreakdownModal() { document.getElementById('score-breakdown-modal').classList.add('hidden'); }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function hideAdminDashboardModal() { document.getElementById('admin-dashboard-modal').classList.add('hidden'); }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function checkAdminPassword() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const password = document.getElementById('admin-password-input').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (password === "HASTIN") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideAdminPasswordModal();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderAdminDashboard();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('admin-dashboard-modal').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showAlert("Access Denied", "Incorrect password.");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('admin-password-input').value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function saveSettings() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Please select a course first.", "error");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const logoUrl = document.getElementById('settings-logo-url').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { 'teacher.logoUrl': logoUrl });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('school-logo').src = logoUrl || 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hideSettingsModal();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Settings saved successfully!", "success");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error saving settings:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to save settings.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- INITIALIZATION ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function populateDropdowns() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const subjectSelect = document.getElementById('select-subject');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const gradeLevelSelect = document.getElementById('select-grade-level');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const academicYearSelect = document.getElementById('select-academic-year');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const semesterSelect = document.getElementById('select-semester');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentSubject = subjectSelect.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentGrade = gradeLevelSelect.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentAcademicYearSelection = academicYearSelect.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentSemesterSelection = semesterSelect.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentRoom = document.getElementById('select-room').value;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>subjectSelect.innerHTML = '&lt;option value=""&gt;Select Subject&lt;/option&gt;' + subjectsList.map(s =&gt; `&lt;option value="${s}"&gt;${s}&lt;/option&gt;`).join('');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>gradeLevelSelect.innerHTML = '&lt;option value=""&gt;Select Grade&lt;/option&gt;' + gradeLevelsList.map(g =&gt; `&lt;option value="${g}"&gt;${g}&lt;/option&gt;`).join('');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentYear = new Date().getFullYear();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const academicYears = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (let i = 0; i &lt;= 10; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>academicYears.push(currentYear + i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>academicYearSelect.innerHTML = '&lt;option value=""&gt;Select Academic Year&lt;/option&gt;' + academicYears.map(y =&gt; `&lt;option value="${y}"&gt;${y}&lt;/option&gt;`).join('');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const semesters = ['Term 1', 'Term 2', 'Term 3'];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>semesterSelect.innerHTML = '&lt;option value=""&gt;Select Semester&lt;/option&gt;' + semesters.map(s =&gt; `&lt;option value="${s}"&gt;${s}&lt;/option&gt;`).join('');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>academicYearSelect.value = localStorage.getItem('selectedAcademicYear') || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>semesterSelect.value = localStorage.getItem('selectedSemester') || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>subjectSelect.value = localStorage.getItem('selectedSubject') || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>gradeLevelSelect.value = localStorage.getItem('selectedGrade') || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('select-room').value = localStorage.getItem('selectedRoom') || '';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>selectedAcademicYear = academicYearSelect.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>selectedSemester = semesterSelect.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- UI State Management ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateMainContentState() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isAcademicPeriodSelected = document.getElementById('select-academic-year').value &amp;&amp; document.getElementById('select-semester').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const academicPeriodStatusDiv = document.getElementById('academic-period-status');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseSelectionSection = document.getElementById('course-selection-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseSelectionOverlay = document.getElementById('course-selection-overlay');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const teacherInfoContainer = document.getElementById('teacher-info-container');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const teacherInfoContainerOverlay = document.getElementById('teacher-info-container-overlay');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isAcademicPeriodSelected) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>academicPeriodStatusDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>academicPeriodStatusDiv.className = 'p-3 rounded-md text-center font-medium mt-4 hidden';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>courseSelectionSection.classList.remove('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>courseSelectionOverlay.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>academicPeriodStatusDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>academicPeriodStatusDiv.textContent = 'Please select both Academic Year and Semester.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>academicPeriodStatusDiv.className = 'p-3 rounded-md text-center font-medium mt-4 bg-yellow-900/50 text-yellow-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>courseSelectionSection.classList.add('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>courseSelectionOverlay.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isCourseSelected = document.getElementById('select-subject').value &amp;&amp; document.getElementById('select-grade-level').value &amp;&amp; document.getElementById('select-room').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isTeacherInfoSaved = activeCourse &amp;&amp; activeCourse.teacher &amp;&amp; activeCourse.teacher.realName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isReadyForMainContent = isAcademicPeriodSelected &amp;&amp; isCourseSelected &amp;&amp; isTeacherInfoSaved;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const mainContent = document.getElementById('main-content-area');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const mainContentOverlay = document.getElementById('main-content-overlay');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isAcademicPeriodSelected &amp;&amp; isCourseSelected) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>teacherInfoContainer.classList.remove('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>teacherInfoContainerOverlay.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>teacherInfoContainer.classList.add('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>teacherInfoContainerOverlay.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>teacherInfoContainerOverlay.querySelector('span').textContent = 'Please select a Course above.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isReadyForMainContent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>mainContent.classList.remove('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>mainContentOverlay.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>mainContent.classList.add('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>mainContentOverlay.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let overlayMessage = 'Please complete: ';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let missingSteps = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!isAcademicPeriodSelected) missingSteps.push('Academic Year &amp; Semester');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!isCourseSelected) missingSteps.push('Course Selection');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!isTeacherInfoSaved) missingSteps.push('Teacher Info (and click Save Info)');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>mainContentOverlay.querySelector('span').textContent = overlayMessage + missingSteps.join(', ') + '.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAll();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- COURSE &amp; TEACHER LOGIC ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateAcademicYearSelection() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>selectedAcademicYear = document.getElementById('select-academic-year').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>localStorage.setItem('selectedAcademicYear', selectedAcademicYear);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCourseSelection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateSemesterSelection() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>selectedSemester = document.getElementById('select-semester').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>localStorage.setItem('selectedSemester', selectedSemester);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCourseSelection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function updateCourseSelection() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const academicYear = document.getElementById('select-academic-year').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const semester = document.getElementById('select-semester').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const subject = document.getElementById('select-subject').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const grade = document.getElementById('select-grade-level').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const room = document.getElementById('select-room').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const statusDiv = document.getElementById('course-selection-status');</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>localStorage.setItem('selectedSubject', subject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>localStorage.setItem('selectedGrade', grade);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>localStorage.setItem('selectedRoom', room);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!academicYear || !semester) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('school-logo').src = 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.textContent = 'Please select Academic Year and Semester first.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.className = 'p-3 rounded-md text-center font-medium bg-yellow-900/50 text-yellow-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>updateMainContentState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (subject &amp;&amp; grade &amp;&amp; room) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const courseId = `${subject}-${grade}-${room}-${academicYear}-${semester}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let course = courses.find(c =&gt; c.id === courseId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!course) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const newCourseData = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>subject,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>gradeLevel: grade,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>room,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>academicYear: Number(academicYear),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>semester,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>assessmentComponents: [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>teacher: { realName: '', id: '' }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${courseId}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>await window.firebase.setDoc(courseDocRef, newCourseData);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>statusDiv.textContent = `New course created: ${subject} (${grade}/${room}) - ${academicYear} ${semester}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>statusDiv.className = 'p-3 rounded-md text-center font-medium bg-blue-900/50 text-blue-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>console.error("Error creating new course:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>showToast("Failed to create new course.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>statusDiv.textContent = `Loaded course: ${subject} (${grade}/${room}) - ${academicYear} ${semester}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>statusDiv.className = 'p-3 rounded-md text-center font-medium bg-green-900/50 text-green-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse = course;</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const logoUrl = activeCourse?.teacher?.logoUrl || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('school-logo').src = logoUrl || 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderTeacherInfoSection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>checkTeacherFormValidity();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('school-logo').src = 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.textContent = 'Please complete all Course selections.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.className = 'p-3 rounded-md text-center font-medium bg-yellow-900/50 text-yellow-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderTeacherInfoSection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>statusDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateMainContentState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAssessmentComponents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCategoryManagementSectionState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function checkTeacherFormValidity() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const realName = document.getElementById('teacher-real-name').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const saveButton = document.getElementById('save-teacher-info-button');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const hint = document.getElementById('save-teacher-hint');</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isCourseSelected = !!activeCourse;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isNameEntered = realName.length &gt; 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>saveButton.disabled = !(isCourseSelected &amp;&amp; isNameEntered);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!saveButton.disabled &amp;&amp; (!activeCourse.teacher || !activeCourse.teacher.realName)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hint.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>hint.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function saveTeacherInfo() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const realName = document.getElementById('teacher-real-name').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const id = document.getElementById('teacher-id').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { teacher: { realName, id, logoUrl: activeCourse.teacher.logoUrl || '' } });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Teacher information saved!', 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error saving teacher info:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to save teacher information.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderTeacherInfoSection() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const displayDiv = document.getElementById('teacher-info-display');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const editFormDiv = document.getElementById('teacher-info-edit-form');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const teacherNameInput = document.getElementById('teacher-real-name');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const teacherIdInput = document.getElementById('teacher-id');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const saveTeacherHint = document.getElementById('save-teacher-hint');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (activeCourse &amp;&amp; activeCourse.teacher &amp;&amp; activeCourse.teacher.realName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>displayDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>editFormDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('display-teacher-name').textContent = activeCourse.teacher.realName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('display-teacher-id').textContent = `ID: ${activeCourse.teacher.id || 'N/A'}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>saveTeacherHint.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>displayDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>editFormDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!activeCourse || !activeCourse.teacher || !activeCourse.teacher.realName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>teacherNameInput.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>teacherIdInput.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>checkTeacherFormValidity();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function editTeacherInfo() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const displayDiv = document.getElementById('teacher-info-display');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const editFormDiv = document.getElementById('teacher-info-edit-form');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const teacherNameInput = document.getElementById('teacher-real-name');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const teacherIdInput = document.getElementById('teacher-id');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>displayDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editFormDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>teacherNameInput.value = activeCourse.teacher.realName || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>teacherIdInput.value = activeCourse.teacher.id || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>checkTeacherFormValidity();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showDeleteTeacherConfirmation() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showConfirmationModal(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>'Confirm Delete Teacher Info',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>'Are you sure you want to delete teacher information for this course? This action cannot be undone.',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>deleteTeacherInfo</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function deleteTeacherInfo() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { teacher: {} });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Teacher information deleted!', 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error deleting teacher info:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to delete teacher information.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function resetCourseData() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseIdentifier = `${activeCourse.subject} (${activeCourse.gradeLevel}/${activeCourse.room}) - ${activeCourse.academicYear} ${activeCourse.semester}`;</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.runTransaction(db, async (transaction) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>transaction.update(courseDocRef, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>assessmentComponents: [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>teacher: {}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const studentsInThisCourseQuery = window.firebase.query(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>window.firebase.collection(db, `/artifacts/${window.appId}/public/data/students`),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>window.firebase.where('gradeLevel', '==', activeCourse.gradeLevel),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>window.firebase.where('room', '==', activeCourse.room)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const querySnapshot = await window.firebase.getDocs(studentsInThisCourseQuery);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>querySnapshot.forEach((doc) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const studentData = doc.data();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const newScores = { ...studentData.scores };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (newScores[activeCourse.id]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>delete newScores[activeCourse.id];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>transaction.update(doc.ref, { scores: newScores });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast(`All data for course "${courseIdentifier}" has been reset!`, 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error resetting course data:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to reset course data.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- ASSESSMENT COMPONENT LOGIC ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateTotalAssessmentComponentWeightDisplay() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeightSpan = document.getElementById('current-total-grading-period-weight');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const warningDiv = document.getElementById('grading-period-warning');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!totalWeightSpan || !warningDiv || !activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>totalWeightSpan.textContent = '0';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>warningDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeight = activeCourse.assessmentComponents.reduce((sum, component) =&gt; sum + Number(component.weight), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>totalWeightSpan.textContent = totalWeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>warningDiv.classList.toggle('hidden', totalWeight === 100 || activeCourse.assessmentComponents.length === 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderAssessmentComponents() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const container = document.getElementById('grading-period-list');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const selectDropdown = document.getElementById('select-grading-period');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>selectDropdown.innerHTML = '&lt;option value=""&gt;Select an Assessment Component&lt;/option&gt;';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>container.innerHTML = activeCourse.assessmentComponents.map((component, index) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const isEditing = editingAssessmentComponentIndex === index;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (isEditing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="p-3 rounded-md shadow-sm border border-indigo-500 card flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;input type="text" value="${component.name}" class="grading-period-name-input flex-grow p-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;input type="number" value="${component.weight}" class="grading-period-weight-input w-20 p-2 text-center"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;span class="text-slate-400"&gt;%&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="saveAssessmentComponentChanges(${index})" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm"&gt;Save&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="cancelEditAssessmentComponent()" class="bg-slate-400 text-white px-3 py-2 rounded-md text-sm"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="flex items-center gap-2 p-2 rounded-md border card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;span class="flex-grow font-medium"&gt;${component.name} (${component.weight}%)&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="startEditAssessmentComponent(${index})" class="bg-yellow-600 text-white px-3 py-1 rounded-md text-sm"&gt;Edit&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="showDeleteAssessmentComponentConfirmation(${index})" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm"&gt;Delete&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).join('');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentSelectedComponentId = selectedAssessmentComponent ? selectedAssessmentComponent.id : '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>selectDropdown.innerHTML = '&lt;option value=""&gt;Select an Assessment Component&lt;/option&gt;' + activeCourse.assessmentComponents.map(component =&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>`&lt;option value="${component.id}" ${component.id === currentSelectedComponentId ? 'selected' : ''}&gt;${component.name}&lt;/option&gt;`</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>).join('');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateTotalAssessmentComponentWeightDisplay();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCategoryManagementSectionState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function addGradingPeriod() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const nameInput = document.getElementById('new-grading-period-name');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const weightInput = document.getElementById('new-grading-period-weight');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const name = nameInput.value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const weight = parseFloat(weightInput.value);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!name || isNaN(weight) || weight &lt;= 0) { showToast('Please enter a valid component name and weight.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (activeCourse.assessmentComponents.some(p =&gt; p.name.toLowerCase() === name.toLowerCase())) { showToast('Assessment component name already exists.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeight = activeCourse.assessmentComponents.reduce((sum, p) =&gt; sum + p.weight, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (totalWeight + weight &gt; 100) { showToast('Total component weight cannot exceed 100%.', 'error'); return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newComponents = [...activeCourse.assessmentComponents, { id: crypto.randomUUID(), name, weight, categories: [] }];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { assessmentComponents: newComponents });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>nameInput.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>weightInput.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Assessment component added successfully!", "success");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error adding assessment component:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to add component.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function startEditAssessmentComponent(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (editingAssessmentComponentIndex !== -1) { showToast('Please save or cancel the current component edit first.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editingAssessmentComponentIndex = index;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalAssessmentComponentState = JSON.parse(JSON.stringify(activeCourse.assessmentComponents[index]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAssessmentComponents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function cancelEditAssessmentComponent() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editingAssessmentComponentIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalAssessmentComponentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAssessmentComponents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function saveAssessmentComponentChanges(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentElement = document.querySelector(`#grading-period-list &gt; div:nth-child(${index + 1})`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newName = componentElement.querySelector('.grading-period-name-input').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newWeight = parseFloat(componentElement.querySelector('.grading-period-weight-input').value);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!newName || isNaN(newWeight) || newWeight &lt; 0) { showToast('Invalid component name or weight.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (activeCourse.assessmentComponents.some((p, i) =&gt; i !== index &amp;&amp; p.name.toLowerCase() === newName.toLowerCase())) { showToast('Assessment component name already exists.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeight = activeCourse.assessmentComponents.reduce((sum, p, i) =&gt; sum + (i === index ? newWeight : p.weight), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (totalWeight &gt; 100) { showToast('Total component weight exceeds 100%.', 'error'); return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const updatedComponents = [...activeCourse.assessmentComponents];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const oldName = updatedComponents[index].name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedComponents[index] = { ...updatedComponents[index], name: newName, weight: newWeight };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.runTransaction(db, async (transaction) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>transaction.update(courseDocRef, { assessmentComponents: updatedComponents });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (newName !== oldName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>studentsInCurrentClass.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${s.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const newScores = { ...s.scores };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>if (newScores[activeCourse.id] &amp;&amp; newScores[activeCourse.id][oldName]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>newScores[activeCourse.id][newName] = newScores[activeCourse.id][oldName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>delete newScores[activeCourse.id][oldName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>transaction.update(studentDocRef, { scores: newScores });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>editingAssessmentComponentIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>originalAssessmentComponentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Assessment component changes saved!', 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error saving assessment component:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to save changes.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showDeleteAssessmentComponentConfirmation(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentName = activeCourse.assessmentComponents[index].name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showConfirmationModal(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>'Confirm Delete Assessment Component',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>`Are you sure you want to delete the assessment component "${componentName}"? All categories and associated scores within this component will be removed. This action cannot be undone.`,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>() =&gt; deleteAssessmentComponent(index)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function deleteAssessmentComponent(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentName = activeCourse.assessmentComponents[index].name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const updatedComponents = [...activeCourse.assessmentComponents];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedComponents.splice(index, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.runTransaction(db, async (transaction) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>transaction.update(courseDocRef, { assessmentComponents: updatedComponents });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>studentsInCurrentClass.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${s.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const newScores = { ...s.scores };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (newScores[activeCourse.id] &amp;&amp; newScores[activeCourse.id][componentName]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>delete newScores[activeCourse.id][componentName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>transaction.update(studentDocRef, { scores: newScores });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast(`Assessment component "${componentName}" removed.`, 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error deleting assessment component:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to delete component.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function selectGradingPeriod() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const selectElement = document.getElementById('select-grading-period');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentId = selectElement.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const statusDiv = document.getElementById('selected-grading-period-status');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const currentComponentNameSpan = document.getElementById('current-period-name');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (componentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>selectedAssessmentComponent = activeCourse.assessmentComponents.find(p =&gt; p.id === componentId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.textContent = `Managing categories for: ${selectedAssessmentComponent.name}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.className = 'p-3 rounded-md text-center font-medium bg-blue-900/50 text-blue-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currentComponentNameSpan.textContent = selectedAssessmentComponent.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>selectedAssessmentComponent = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.textContent = 'No Assessment Component selected.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>statusDiv.className = 'p-3 rounded-md text-center font-medium bg-yellow-900/50 text-yellow-300';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currentComponentNameSpan.textContent = 'Selected Assessment Component';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>statusDiv.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCategoryManagementSectionState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderCategories();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAll();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateCategoryManagementSectionState() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const categoryManagementSection = document.getElementById('category-management-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const categoryManagementOverlay = document.getElementById('category-management-overlay');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (selectedAssessmentComponent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>categoryManagementSection.classList.remove('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>categoryManagementOverlay.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>categoryManagementSection.classList.add('disabled-section');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>categoryManagementOverlay.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateTotalCategoryWeightDisplay();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- CATEGORY LOGIC ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateTotalCategoryWeightDisplay() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeightSpan = document.getElementById('current-total-category-weight');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const warningDiv = document.getElementById('category-weight-warning');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!totalWeightSpan || !warningDiv || !selectedAssessmentComponent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>totalWeightSpan.textContent = '0';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>warningDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeight = selectedAssessmentComponent.categories.reduce((sum, cat) =&gt; sum + Number(cat.weight), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>totalWeightSpan.textContent = totalWeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>warningDiv.classList.toggle('hidden', totalWeight === 100 || selectedAssessmentComponent.categories.length === 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderCategories() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const container = document.getElementById('category-settings');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!selectedAssessmentComponent) { container.innerHTML = ''; return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>container.innerHTML = selectedAssessmentComponent.categories.map((cat, index) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const isEditing = editingCategoryIndex === index;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (isEditing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;details class="p-3 rounded-md shadow-sm border border-indigo-500 card" open&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;summary class="flex items-center gap-4 cursor-pointer font-medium text-lg"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" value="${cat.name}" class="category-name-input flex-grow p-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="number" value="${cat.weight}" class="category-weight-input w-20 p-2 text-center"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;span class="text-slate-400"&gt;%&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="saveCategoryChanges(${index})" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm"&gt;Save&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="cancelEditCategory()" class="bg-slate-400 text-white px-3 py-2 rounded-md text-sm"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/summary&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="ml-8 mt-4 border-l-2 pl-4 border-slate-800"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;h4 class="text-md font-semibold mb-2"&gt;Sub-items:&lt;/h4&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div id="sub-items-${index}" class="space-y-2 mb-4"&gt;${renderSubItems(index)}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;input type="text" id="new-sub-item-name-${index}" placeholder="Sub-item name" class="flex-grow p-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;input type="number" id="new-sub-item-max-score-${index}" placeholder="Max Score" class="w-24 p-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;button onclick="addSubItem(${index})" class="bg-blue-500 text-white px-3 py-2 rounded-md"&gt;Add&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/details&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;details class="p-3 rounded-md shadow-sm border card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;summary class="flex items-center gap-4 cursor-pointer font-medium text-lg"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;span class="flex-grow"&gt;${cat.name} (${cat.weight}%)&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="startEditCategory(${index})" class="bg-yellow-500 text-white px-3 py-2 rounded-md text-sm"&gt;Edit&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="showDeleteCategoryConfirmation(${index})" class="bg-red-500 text-white px-3 py-2 rounded-md text-sm"&gt;Delete&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/summary&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="ml-8 mt-4 border-l-2 pl-4 border-slate-800"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;h4 class="text-md font-semibold mb-2"&gt;Sub-items:&lt;/h4&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div id="sub-items-readonly-${index}" class="space-y-2 mb-4"&gt;${renderSubItems(index)}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/details&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).join('');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateTotalCategoryWeightDisplay();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderSubItems(catIndex) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const cat = selectedAssessmentComponent.categories[catIndex];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const isEditing = editingCategoryIndex === catIndex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!cat.subItems || cat.subItems.length === 0) return '&lt;p class="text-slate-400 text-sm"&gt;No sub-items for this category.&lt;/p&gt;';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return cat.subItems.map((sub, subIndex) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (isEditing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `&lt;div class="flex items-center gap-2 bg-slate-800 p-2 rounded-md"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" value="${sub.name}" class="sub-item-name-input flex-grow p-1 text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="number" value="${sub.maxScore}" class="sub-item-max-score-input w-20 p-1 text-center text-sm"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="removeSubItem(${catIndex}, ${subIndex})" class="bg-red-400 text-white px-2 py-1 rounded-md text-sm"&gt;Del&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `&lt;div class="flex items-center gap-2 bg-slate-800 p-2 rounded-md"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;span class="flex-grow text-sm"&gt;${sub.name}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;span class="text-slate-400 text-sm"&gt;${formatNumber(sub.maxScore)} pts&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).join('');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function addCategory() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!selectedAssessmentComponent) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const nameInput = document.getElementById('new-category-name');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const weightInput = document.getElementById('new-category-weight');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const name = nameInput.value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const weight = parseFloat(weightInput.value);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!name || isNaN(weight) || weight &lt;= 0) { showToast('Please enter a valid name and weight.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (selectedAssessmentComponent.categories.some(c =&gt; c.name.toLowerCase() === name.toLowerCase())) { showToast('Category name already exists in this component.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeight = selectedAssessmentComponent.categories.reduce((sum, c) =&gt; sum + c.weight, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (totalWeight + weight &gt; 100) { showToast('Total category weight for this component cannot exceed 100%.', 'error'); return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newCategories = [...selectedAssessmentComponent.categories, { id: crypto.randomUUID(), name, weight, subItems: [] }];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentIndex = activeCourse.assessmentComponents.findIndex(c =&gt; c.id === selectedAssessmentComponent.id);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { [`assessmentComponents.${componentIndex}.categories`]: newCategories });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>nameInput.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>weightInput.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Category added successfully!", "success");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error adding category:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to add category.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function handleCategoryCsvImport(event) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!selectedAssessmentComponent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Please select an Assessment Component first to import categories.", "error");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const file = event.target.files[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!file) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const reader = new FileReader();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>reader.onload = async e =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const lines = e.target.result.split(/\r\n|\n/).filter(line =&gt; line.trim() !== '').slice(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const newCategories = [...selectedAssessmentComponent.categories];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let added = 0, updated = 0, skipped = 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>lines.forEach(line =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const [categoryName, weight] = line.split(',').map(f =&gt; f.trim());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const parsedWeight = parseFloat(weight);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (!categoryName || isNaN(parsedWeight) || parsedWeight &lt;= 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>skipped++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const existingIndex = newCategories.findIndex(c =&gt; c.name.toLowerCase() === categoryName.toLowerCase());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const totalWeight = newCategories.reduce((sum, c) =&gt; sum + c.weight, 0);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (existingIndex !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const currentCategoryWeight = newCategories[existingIndex].weight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if ((totalWeight - currentCategoryWeight + parsedWeight) &gt; 100) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>showToast(`Cannot update "${categoryName}": Total weight for this component would exceed 100%.`, 'error', 5000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>skipped++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>newCategories[existingIndex].weight = parsedWeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>updated++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} else if (totalWeight + parsedWeight &gt; 100) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>showToast(`Cannot add "${categoryName}": Total weight for this component would exceed 100%.`, 'error', 5000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>skipped++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>newCategories.push({ id: crypto.randomUUID(), name: categoryName, weight: parsedWeight, subItems: [] });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>added++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const componentIndex = activeCourse.assessmentComponents.findIndex(c =&gt; c.id === selectedAssessmentComponent.id);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>await window.firebase.updateDoc(courseDocRef, { [`assessmentComponents.${componentIndex}.categories`]: newCategories });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>showToast(`Category import complete! Added: ${added}, Updated: ${updated}, Skipped: ${skipped}.`, 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>console.error("Error importing categories:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>showToast("Failed to import categories.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>reader.readAsText(file);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>event.target.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showDeleteCategoryConfirmation(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const categoryName = selectedAssessmentComponent.categories[index].name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showConfirmationModal(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>'Confirm Delete Category',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>`Are you sure you want to delete the category "${categoryName}"? All associated scores for this category will be removed from all students. This action cannot be undone.`,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>() =&gt; deleteCategory(index)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function deleteCategory(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!selectedAssessmentComponent) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const catName = selectedAssessmentComponent.categories[index].name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const updatedCategories = [...selectedAssessmentComponent.categories];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedCategories.splice(index, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentIndex = activeCourse.assessmentComponents.findIndex(c =&gt; c.id === selectedAssessmentComponent.id);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">             </span>await window.firebase.runTransaction(db, async (transaction) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>transaction.update(courseDocRef, { [`assessmentComponents.${componentIndex}.categories`]: updatedCategories });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>studentsInCurrentClass.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${s.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const newScores = { ...s.scores };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (newScores[activeCourse.id] &amp;&amp; newScores[activeCourse.id][selectedAssessmentComponent.name] &amp;&amp; newScores[activeCourse.id][selectedAssessmentComponent.name][catName]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>delete newScores[activeCourse.id][selectedAssessmentComponent.name][catName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>transaction.update(studentDocRef, { scores: newScores });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast(`Category "${catName}" removed.`, 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error removing category:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to remove category.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function startEditCategory(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (editingCategoryIndex !== -1) { showToast('Please save or cancel the current edit first.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editingCategoryIndex = index;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalCategoryState = JSON.parse(JSON.stringify(selectedAssessmentComponent.categories[index]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderCategories();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function cancelEditCategory() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editingCategoryIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalCategoryState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderCategories();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function saveCategoryChanges(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const catElement = document.querySelector(`#category-settings details:nth-child(${index + 1})`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newName = catElement.querySelector('.category-name-input').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newWeight = parseFloat(catElement.querySelector('.category-weight-input').value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!newName || isNaN(newWeight) || newWeight &lt; 0) { showToast('Invalid name or weight.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (selectedAssessmentComponent.categories.some((c, i) =&gt; i !== index &amp;&amp; c.name.toLowerCase() === newName.toLowerCase())) { showToast('Category name already exists in this component.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const totalWeight = selectedAssessmentComponent.categories.reduce((sum, c, i) =&gt; sum + (i === index ? newWeight : c.weight), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (totalWeight &gt; 100) { showToast('Total category weight for this component cannot exceed 100%.', 'error'); return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newSubItems = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const subItemElements = catElement.querySelectorAll(`#sub-items-${index} &gt; div`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>subItemElements.forEach(el =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const subName = el.querySelector('.sub-item-name-input')?.value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const maxScore = parseFloat(el.querySelector('.sub-item-max-score-input')?.value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (subName &amp;&amp; !isNaN(maxScore) &amp;&amp; maxScore &gt;= 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const existingSubItem = originalCategoryState.subItems?.find(sub =&gt; sub.name.toLowerCase() === subName.toLowerCase());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>newSubItems.push({ id: existingSubItem ? existingSubItem.id : crypto.randomUUID(), name: subName, maxScore });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else if (subName &amp;&amp; (isNaN(maxScore) || maxScore &lt; 0)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>showToast(`Invalid max score for sub-item "${subName}". Must be a number &gt;= 0.`, 'error', 5000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const updatedCategories = [...activeCourse.assessmentComponents.find(c =&gt; c.id === selectedAssessmentComponent.id).categories];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const oldName = updatedCategories[index].name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedCategories[index] = { ...updatedCategories[index], name: newName, weight: newWeight, subItems: newSubItems };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentIndex = activeCourse.assessmentComponents.findIndex(c =&gt; c.id === selectedAssessmentComponent.id);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.runTransaction(db, async (transaction) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>transaction.update(courseDocRef, { [`assessmentComponents.${componentIndex}.categories`]: updatedCategories });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (newName !== oldName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>studentsInCurrentClass.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${s.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const newScores = { ...s.scores };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>if (newScores[activeCourse.id] &amp;&amp; newScores[activeCourse.id][selectedAssessmentComponent.name] &amp;&amp; newScores[activeCourse.id][selectedAssessmentComponent.name][oldName]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>newScores[activeCourse.id][selectedAssessmentComponent.name][newName] = newScores[activeCourse.id][selectedAssessmentComponent.name][oldName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>delete newScores[activeCourse.id][selectedAssessmentComponent.name][oldName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>transaction.update(studentDocRef, { scores: newScores });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>editingCategoryIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>originalCategoryState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Category changes saved!', 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error saving category changes:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to save category changes.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function addSubItem(catIndex) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!selectedAssessmentComponent) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const name = document.getElementById(`new-sub-item-name-${catIndex}`).value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const maxScore = parseFloat(document.getElementById(`new-sub-item-max-score-${catIndex}`).value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!name || isNaN(maxScore) || maxScore &lt; 0) { showToast('Invalid sub-item name or max score (must be &gt;= 0).', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const cat = selectedAssessmentComponent.categories[catIndex];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!cat.subItems) cat.subItems = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (cat.subItems.some(sub =&gt; sub.name.toLowerCase() === name.toLowerCase())) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Sub-item name already exists in this category.', 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const updatedCategories = [...selectedAssessmentComponent.categories];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedCategories[catIndex].subItems.push({ id: crypto.randomUUID(), name, maxScore });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentIndex = activeCourse.assessmentComponents.findIndex(c =&gt; c.id === selectedAssessmentComponent.id);</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { [`assessmentComponents.${componentIndex}.categories`]: updatedCategories });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById(`new-sub-item-name-${catIndex}`).value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById(`new-sub-item-max-score-${catIndex}`).value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Sub-item added successfully!", "success");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error adding sub-item:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to add sub-item.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function removeSubItem(catIndex, subIndex) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!selectedAssessmentComponent) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const updatedCategories = [...selectedAssessmentComponent.categories];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedCategories[catIndex].subItems.splice(subIndex, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const courseDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/courses/${activeCourse.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const componentIndex = activeCourse.assessmentComponents.findIndex(c =&gt; c.id === selectedAssessmentComponent.id);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(courseDocRef, { [`assessmentComponents.${componentIndex}.categories`]: updatedCategories });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Sub-item removed successfully!", "success");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error removing sub-item:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to remove sub-item.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- STUDENT LOGIC ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function checkAddStudentFormValidity() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const name = document.getElementById('new-student-real-name').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const id = document.getElementById('new-student-id').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const roll = document.getElementById('new-student-roll-number').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('add-student-button').disabled = !name || !id || !roll;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function addStudent() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const realName = document.getElementById('new-student-real-name').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const nickname = document.getElementById('new-student-nickname').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentId = document.getElementById('new-student-id').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const rollNumber = document.getElementById('new-student-roll-number').value.trim();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (students.some(s =&gt; s.studentId === studentId)) { showToast('Student ID already exists in the system. Please use a unique ID.', 'error'); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentsInCurrentClass.some(s =&gt; s.rollNumber === rollNumber)) { showToast('Roll Number already exists for another student in this class.', 'error'); return; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newStudent = { studentId, realName, nickname, rollNumber, gradeLevel: activeCourse.gradeLevel, room: activeCourse.room, scores: {} };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsRef = window.firebase.collection(db, `/artifacts/${window.appId}/public/data/students`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.addDoc(studentsRef, newStudent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>['new-student-real-name', 'new-student-nickname', 'new-student-id', 'new-student-roll-number'].forEach(id =&gt; document.getElementById(id).value = '');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>checkAddStudentFormValidity();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast(`${realName} has been added.`, 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error adding student:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to add student.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showDeleteStudentConfirmation(studentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const student = students.find(s =&gt; s.studentId === studentId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!student) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showConfirmationModal(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>'Confirm Delete Student',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>`Are you sure you want to delete student "${student.realName}" (ID: ${student.studentId})? All their scores will be removed. This action cannot be undone.`,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>() =&gt; removeStudent(studentId)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function removeStudent(studentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const student = students.find(s =&gt; s.studentId === studentId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!student) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${student.id}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.deleteDoc(studentDocRef);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Student removed.', 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error removing student:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to remove student.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function startEditStudent(studentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (editingStudentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Please save or cancel the current student edit first.', 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editingStudentId = studentId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalStudentState = JSON.parse(JSON.stringify(students.find(s =&gt; s.studentId === studentId)));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderStudents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function cancelEditStudent() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>editingStudentId = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalStudentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderStudents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function saveStudentChanges(studentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const student = students.find(s =&gt; s.studentId === studentId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!student) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentRow = document.getElementById(`student-${student.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newRealName = studentRow.querySelector('.edit-student-real-name').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newNickname = studentRow.querySelector('.edit-student-nickname').value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const newRollNumber = studentRow.querySelector('.edit-student-roll-number').value.trim();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!newRealName || !newRollNumber) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Student name and roll number cannot be empty.', 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentsInCurrentClass.some(s =&gt; s.studentId !== studentId &amp;&amp; s.rollNumber === newRollNumber)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Roll Number already exists for another student in this class.', 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${student.id}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(studentDocRef, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>realName: newRealName,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>nickname: newNickname,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>rollNumber: newRollNumber</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>editingStudentId = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>originalStudentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast('Student details updated!', 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.error("Error updating student:", e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to update student.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderStudents() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const container = document.getElementById('student-list');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) { container.innerHTML = ''; return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentsInClass.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '&lt;p class="text-slate-400 text-center p-4"&gt;No students in this class yet.&lt;/p&gt;';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>container.innerHTML = studentsInClass.sort((a, b) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const rollA = parseInt(a.rollNumber, 10);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const rollB = parseInt(b.rollNumber, 10);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return rollA - rollB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).map(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (editingStudentId === s.studentId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="student-${s.id}" class="p-2 rounded-md border-2 border-indigo-500 card space-y-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="grid grid-cols-2 gap-3"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" value="${s.realName}" class="edit-student-real-name p-1 col-span-2" placeholder="Full Name"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" value="${s.nickname || ''}" class="edit-student-nickname p-1 col-span-2" placeholder="Nickname"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" value="${s.studentId}" class="edit-student-id p-1" placeholder="Student ID" disabled&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="number" value="${s.rollNumber}" class="edit-student-roll-number p-1" placeholder="Roll No."&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="saveStudentChanges('${s.studentId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded-md text-sm"&gt;Save&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="cancelEditStudent()" class="w-full bg-slate-500 text-white px-3 py-1 rounded-md text-sm"&gt;Cancel&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="student-${s.id}" class="flex items-center gap-2 p-2 rounded-md border card hover:bg-slate-800"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex-grow"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p class="font-medium"&gt;${s.rollNumber}. ${s.realName} &lt;span class="text-slate-400 text-sm"&gt;(${s.nickname || '-'})&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-slate-500"&gt;ID: ${s.studentId} | Grade: ${s.gradeLevel}/${s.room}&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="flex gap-2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="startEditStudent('${s.studentId}')" class="bg-yellow-600 text-white px-3 py-1 rounded-md text-sm"&gt;Edit&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;button onclick="showDeleteStudentConfirmation('${s.studentId}')" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm"&gt;Delete&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).join('');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function handleCsvImport(event) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Please select a course first to import students.", "error");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const file = event.target.files[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!file) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const reader = new FileReader();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>reader.onload = async e =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const lines = e.target.result.split(/\r\n|\n/).filter(line =&gt; line.trim() !== '').slice(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let added = 0, updated = 0, skipped = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const studentsRef = window.firebase.collection(db, `/artifacts/${window.appId}/public/data/students`);</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.runTransaction(db, async (transaction) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>for (const line of lines) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const [studentId, realName, nickname, rollNumber] = line.split(',').map(f =&gt; f.trim());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (!studentId || !realName || !rollNumber) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>skipped++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>console.warn(`Skipping invalid student CSV row: ${line}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const existingStudentQuery = window.firebase.query(studentsRef, window.firebase.where('studentId', '==', studentId));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const existingStudentSnapshot = await window.firebase.getDocs(existingStudentQuery);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const studentsInCurrentClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const rollNumberExistsInCurrentClass = studentsInCurrentClass.some(s =&gt; s.studentId !== studentId &amp;&amp; s.rollNumber === rollNumber);</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">                    </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (!existingStudentSnapshot.empty) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const existingStudentDoc = existingStudentSnapshot.docs[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>if (rollNumberExistsInCurrentClass &amp;&amp; existingStudentDoc.data().rollNumber !== rollNumber) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>showToast(`Student with Roll Number ${rollNumber} already exists in this class, skipping update for ${realName} (ID: ${studentId}).`, 'error', 5000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>skipped++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>transaction.update(existingStudentDoc.ref, { realName, nickname, rollNumber, gradeLevel: activeCourse.gradeLevel, room: activeCourse.room });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>updated++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>} else if (rollNumberExistsInCurrentClass) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>showToast(`Conflict: Student with Roll Number ${rollNumber} already exists in this class. Skipping import for ${realName}.`, 'error', 7000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>skipped++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const newStudentRef = window.firebase.doc(studentsRef);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>transaction.set(newStudentRef, { studentId, realName, nickname, rollNumber, gradeLevel: activeCourse.gradeLevel, room: activeCourse.room, scores: {} });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>added++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast(`Import complete! Added: ${added}, Updated: ${updated}, Skipped: ${skipped}.`, 'success');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>reader.readAsText(file);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>event.target.value = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- NEW: EXPORT TO CSV ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function exportScoresToCsv() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse || students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room).length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("No student data to export for this course.", "error");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                         </span>.sort((a, b) =&gt; parseInt(a.rollNumber, 10) - parseInt(b.rollNumber, 10));</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let csvContent = "data:text/csv;charset=utf-8,";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const headers = ["Roll Number", "Student ID", "Full Name", "Nickname"];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>activeCourse.assessmentComponents.forEach(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>cat.subItems.forEach(sub =&gt; headers.push(`"${component.name.replace(/"/g, '""')} - ${cat.name.replace(/"/g, '""')} - ${sub.name.replace(/"/g, '""')}"`));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>headers.push(`"${cat.name.replace(/"/g, '""')}"`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>headers.push("Final Score (%)", "Final Grade");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>csvContent += headers.join(",") + "\r\n";</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>studentsInClass.forEach(student =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const row = [</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>student.rollNumber,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>student.studentId,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>`"${student.realName.replace(/"/g, '""')}"`,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>`"${(student.nickname || '').replace(/"/g, '""')}"`</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse.assessmentComponents.forEach(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>cat.subItems.forEach(sub =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>const score = student.scores[activeCourse.id]?.[component.name]?.[cat.name]?.[sub.id] || '0';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>row.push(score);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const score = student.scores[activeCourse.id]?.[component.name]?.[cat.name] || '0';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>row.push(score);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const { finalScore, grade } = calculateFinalScoreAndGrade(student, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>row.push(finalScore, `"${grade}"`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>csvContent += row.join(",") + "\r\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const encodedUri = encodeURI(csvContent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const link = document.createElement("a");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>link.setAttribute("href", encodedUri);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>link.setAttribute("download", `${activeCourse.subject}_${activeCourse.gradeLevel}_${activeCourse.room}_${activeCourse.academicYear}_${activeCourse.semester}_scores.csv`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.body.appendChild(link);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>link.click();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.body.removeChild(link);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showToast("Scores exported successfully!", "success");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// --- SCORE CALCULATION &amp; RENDERING ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getCategoryScores(student, componentName, category, courseToUse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let current = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let max = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!courseToUse || !student.scores || !student.scores[courseToUse.id] || !student.scores[courseToUse.id][componentName]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return { current: 0, max: 0 };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const catScores = student.scores[courseToUse.id][componentName][category.name] || {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (category.subItems &amp;&amp; category.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>category.subItems.forEach(sub =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>max += Number(sub.maxScore);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const subScoreValue = parseFloat(catScores[sub.id] || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>current += subScoreValue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>max = 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>current = parseFloat(catScores || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return { current, max };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function calculateFinalScoreAndGrade(student, course) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let totalWeightedCourseScore = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!course || !student.scores[course.id] || !course.assessmentComponents || course.assessmentComponents.length === 0) return { finalScore: '0.00', grade: 'N/A' };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>course.assessmentComponents.forEach(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let totalComponentScore = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let totalComponentMaxWeight = 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!Array.isArray(component.categories)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const { current, max } = getCategoryScores(student, component.name, cat, course);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (max &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const categoryPercentage = (current / max);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>totalComponentScore += categoryPercentage * cat.weight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>totalComponentMaxWeight += cat.weight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (totalComponentMaxWeight &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const normalizedComponentScore = (totalComponentScore / totalComponentMaxWeight) * 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>totalWeightedCourseScore += (normalizedComponentScore / 100) * component.weight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const score = Math.min(totalWeightedCourseScore, 100);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let grade = 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isNaN(score)) grade = 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 90) grade = 'A+';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 85) grade = 'A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 80) grade = 'A-';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 75) grade = 'B+';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 70) grade = 'B';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 65) grade = 'B-';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 60) grade = 'C+';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 55) grade = 'C';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 50) grade = 'C-';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (score &gt;= 45) grade = 'D';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else grade = 'F';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return { finalScore: score.toFixed(2), grade };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function updateSubScore(studentId, componentName, catName, subId, value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const student = students.find(s =&gt; s.studentId === studentId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!student || !activeCourse) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentDocRef = window.firebase.doc(db, `/artifacts/${window.appId}/public/data/students/${student.id}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const score = parseFloat(value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const component = activeCourse.assessmentComponents.find(p =&gt; p.name === componentName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!component) { return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const category = component.categories.find(c =&gt; c.name === catName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!category) { return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let maxScore = 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (subId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const subItem = category.subItems.find(s =&gt; s.id === subId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (subItem) maxScore = subItem.maxScore; else { return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (value.trim() !== '' &amp;&amp; (isNaN(score) || score &lt; 0 || score &gt; maxScore)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast(`Score must be between 0 and ${formatNumber(maxScore)}.`, 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const currentScore = student.scores[activeCourse.id]?.[componentName]?.[catName]?.[subId] || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.querySelector(`input[onchange*='${studentId}'][onchange*='${componentName}'][onchange*='${catName}'][onchange*='${subId || 'null'}']`).value = currentScore;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let newScores = { ...student.scores };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!newScores[activeCourse.id]) newScores[activeCourse.id] = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!newScores[activeCourse.id][componentName]) newScores[activeCourse.id][componentName] = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!newScores[activeCourse.id][componentName][catName]) newScores[activeCourse.id][componentName][catName] = {};</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const scoreToSave = (value.trim() === '') ? 0 : score;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (subId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>newScores[activeCourse.id][componentName][catName][subId] = scoreToSave;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>newScores[activeCourse.id][componentName][catName] = scoreToSave;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>await window.firebase.updateDoc(studentDocRef, { scores: newScores });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch (e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>showToast("Failed to update score.", 'error');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderScoresTable() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const container = document.getElementById('score-input-table');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const info = document.getElementById('score-entry-info');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse || !activeCourse.assessmentComponents || activeCourse.assessmentComponents.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Please add Assessment Components and Categories to begin.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentsInClass.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Please add students to begin.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const hasCategories = activeCourse.assessmentComponents.some(component =&gt; component.categories &amp;&amp; component.categories.length &gt; 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!hasCategories) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Please add Categories within your Assessment Components to begin.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>info.classList.add('hidden');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let tableHTML = `&lt;table class="min-w-full border-collapse"&gt;&lt;thead&gt;&lt;tr class="sticky-header"&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;th rowspan="3" class="sticky-col p-2 border border-slate-600 text-left"&gt;Student&lt;/th&gt;`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>activeCourse.assessmentComponents.forEach((component, componentIndex) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const totalCategoriesInComponent = component.categories.reduce((sum, cat) =&gt; sum + (cat.subItems &amp;&amp; cat.subItems.length &gt; 0 ? cat.subItems.length + 1 : 2), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (totalCategoriesInComponent &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>tableHTML += `&lt;th colspan="${totalCategoriesInComponent}" class="p-2 border border-slate-600 text-center" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}"&gt;${component.name} (${component.weight}%)&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;th rowspan="3" class="p-2 border border-slate-600"&gt;Final Score&lt;/th&gt;&lt;th rowspan="3" class="p-2 border border-slate-600"&gt;Final Grade&lt;/th&gt;&lt;/tr&gt;`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;tr class="sticky-header"&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>activeCourse.assessmentComponents.forEach((component, componentIndex) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>component.categories.forEach((cat, catIndex) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const colspan = (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) ? cat.subItems.length + 1 : 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>tableHTML += `&lt;th colspan="${colspan}" class="p-2 border border-slate-600 text-center" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}"&gt;${cat.name} (${cat.weight}%)&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;/tr&gt;`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;tr class="sticky-header"&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>activeCourse.assessmentComponents.forEach((component, componentIndex) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>component.categories.forEach((cat, catIndex) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>cat.subItems.forEach(sub =&gt; tableHTML += `&lt;th class="p-2 border border-slate-600 text-center font-normal" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}"&gt;${sub.name} (${formatNumber(sub.maxScore)})&lt;/th&gt;`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>tableHTML += `&lt;th class="p-2 border border-slate-600 text-center font-medium category-total-header" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}"&gt;Cat. Total&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>tableHTML += `&lt;th class="p-2 border border-slate-600 text-center font-normal" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}"&gt;Score (${formatNumber(100)})&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>tableHTML += `&lt;th class="p-2 border border-slate-600 text-center font-medium category-total-header" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}"&gt;Cat. Total&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>studentsInClass.sort((a, b) =&gt; parseInt(a.rollNumber, 10) - parseInt(b.rollNumber, 10)).forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const { finalScore, grade } = calculateFinalScoreAndGrade(s, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tableHTML += `&lt;tr class="hover:bg-slate-800"&gt;&lt;td class="sticky-col p-2 border border-slate-600 text-left font-medium"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;${s.rollNumber}. ${s.realName} &lt;span class="text-slate-400 text-sm"&gt;(${s.nickname || '-'})&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-xs text-slate-400 font-normal"&gt;ID: ${s.studentId}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse.assessmentComponents.forEach(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const catScores = getCategoryScores(s, component.name, cat, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const categoryPercentage = (catScores.max &gt; 0 ? (catScores.current / catScores.max) * 100 : 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>cat.subItems.forEach(sub =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>const subScore = s.scores[activeCourse.id]?.[component.name]?.[cat.name]?.[sub.id] || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>tableHTML += `&lt;td class="p-1 border border-slate-600"&gt;&lt;input type="number" class="w-full p-1 text-center score-input bg-slate-800" value="${subScore}" onchange="updateSubScore('${s.studentId}', '${component.name}', '${cat.name}', '${sub.id}', this.value)" min="0" max="${sub.maxScore}"&gt;&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>tableHTML += `&lt;td class="p-2 border border-slate-600 text-center font-medium category-total-cell"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>${formatNumber(catScores.current)}&lt;br&gt;(${Math.round(categoryPercentage)}%)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const score = s.scores[activeCourse.id]?.[component.name]?.[cat.name] || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const currentScore = parseFloat(score || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>const singleCategoryPercentage = (100 &gt; 0 ? (currentScore / 100) * 100 : 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>tableHTML += `&lt;td class="p-1 border border-slate-600"&gt;&lt;input type="number" class="w-full p-1 text-center score-input bg-slate-800" value="${score}" onchange="updateSubScore('${s.studentId}', '${component.name}', '${cat.name}', null, this.value)" min="0" max="100"&gt;&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>tableHTML += `&lt;td class="p-2 border border-slate-600 text-center font-medium category-total-cell"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>${formatNumber(currentScore)}&lt;br&gt;(${Math.round(singleCategoryPercentage)}%)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tableHTML += `&lt;td class="p-2 border border-slate-600 text-center font-bold final-score-cell"&gt;${formatNumber(finalScore)}&lt;/td&gt;&lt;td class="p-2 border border-slate-600 text-center font-bold final-grade-cell"&gt;${grade}&lt;/td&gt;&lt;/tr&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;/tbody&gt;&lt;/table&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>container.innerHTML = tableHTML;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderSummary() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const container = document.getElementById('summary-table');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const info = document.getElementById('summary-info');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!activeCourse || !activeCourse.assessmentComponents || activeCourse.assessmentComponents.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Enter scores to see the summary.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('advanced-dashboard').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const studentsInClass = students.filter(s =&gt; s.gradeLevel === activeCourse.gradeLevel &amp;&amp; s.room === activeCourse.room);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentsInClass.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Enter scores to see the summary.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('advanced-dashboard').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const hasCategories = activeCourse.assessmentComponents.some(component =&gt; component.categories &amp;&amp; component.categories.length &gt; 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!hasCategories) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Please add Categories within your Assessment Components to see the summary.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>container.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('advanced-dashboard').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>info.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('advanced-dashboard').classList.remove('hidden');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let tableHTML = `&lt;table class="min-w-full"&gt;&lt;thead&gt;&lt;tr&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;th class="p-2 border border-slate-600 text-left"&gt;Student&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>activeCourse.assessmentComponents.forEach((component, i) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tableHTML += `&lt;th class="p-2 border border-slate-600 text-center" style="background-color: ${tableHeaderColors[i % tableHeaderColors.length]}"&gt;${component.name} (%)&lt;/th&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;th class="p-2 border border-slate-600"&gt;Final Score&lt;/th&gt;&lt;th class="p-2 border border-slate-600"&gt;Final Grade&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>studentsInClass.sort((a,b) =&gt; parseFloat(calculateFinalScoreAndGrade(b, activeCourse).finalScore) - parseFloat(calculateFinalScoreAndGrade(a, activeCourse).finalScore)).forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const { finalScore, grade } = calculateFinalScoreAndGrade(s, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let rowBgClass = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let detailsButtonText = 'View Details';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let detailsButtonClass = 'bg-indigo-700 hover:bg-indigo-600';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (parseFloat(finalScore) &gt;= 70) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>rowBgClass = 'bg-green-900/20';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>detailsButtonText = 'Details (Excellent)';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>detailsButtonClass = 'bg-green-800 hover:bg-green-700';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else if (parseFloat(finalScore) &gt;= 50) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>rowBgClass = 'bg-yellow-900/20';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>detailsButtonText = 'Details (Average)';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>detailsButtonClass = 'bg-yellow-800 hover:bg-yellow-700';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>rowBgClass = 'bg-red-900/20';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>detailsButtonText = 'Details (Needs Improvement)';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>detailsButtonClass = 'bg-red-800 hover:bg-red-700';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tableHTML += `&lt;tr class="${rowBgClass}"&gt;&lt;td class="p-2 border border-slate-600 font-medium"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;${s.rollNumber}. ${s.realName} &lt;span class="text-slate-400 text-sm"&gt;(${s.nickname || '-'})&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-xs text-slate-400 font-normal"&gt;ID: ${s.studentId}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="showScoreBreakdownModal('${s.studentId}')" class="mt-1 text-xs ${detailsButtonClass} px-2 py-1 rounded transition-colors"&gt;${detailsButtonText}&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>activeCourse.assessmentComponents.forEach(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>let componentCurrentScore = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>let componentMaxWeight = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (!Array.isArray(component.categories)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>tableHTML += `&lt;td class="p-2 border border-slate-600 text-center"&gt;N/A&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>const { current, max } = getCategoryScores(s, component.name, cat, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (max &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>componentCurrentScore += (current / max) * cat.weight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>componentMaxWeight += cat.weight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const componentPercentage = componentMaxWeight &gt; 0 ? (componentCurrentScore / componentMaxWeight) * 100 : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>tableHTML += `&lt;td class="p-2 border border-slate-600 text-center"&gt;${formatNumber(componentPercentage)}%&lt;/td&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tableHTML += `&lt;td class="p-2 border border-slate-600 text-center font-bold"&gt;${formatNumber(finalScore)}&lt;/td&gt;&lt;td class="p-2 border border-slate-600 text-center font-bold"&gt;${grade}&lt;/td&gt;&lt;/tr&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tableHTML += `&lt;/tbody&gt;&lt;/table&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>container.innerHTML = tableHTML;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAdvancedDashboard(studentsInClass);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderAdvancedDashboard(studentsInClass) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const excellentUl = document.getElementById('group-excellent');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const averageUl = document.getElementById('group-average');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const improvementUl = document.getElementById('group-improvement');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>excellentUl.innerHTML = averageUl.innerHTML = improvementUl.innerHTML = '';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let counts = { excellent: 0, average: 0, improvement: 0 };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>studentsInClass.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const { finalScore } = calculateFinalScoreAndGrade(s, activeCourse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const score = parseFloat(finalScore);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const li = document.createElement('li');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>li.textContent = `${s.realName} (${formatNumber(score)}%)`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (score &gt;= 70) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>excellentUl.appendChild(li);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>counts.excellent++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else if (score &gt;= 50) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>averageUl.appendChild(li);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>counts.average++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>improvementUl.appendChild(li);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>counts.improvement++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const ctx = document.getElementById('student-group-chart').getContext('2d');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (studentGroupChartInstance) studentGroupChartInstance.destroy();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>studentGroupChartInstance = new Chart(ctx, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>type: 'pie',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>data: {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>labels: ['Excellent', 'Average', 'Needs Improvement'],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>datasets: [{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>data: [counts.excellent, counts.average, counts.improvement],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>options: {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>responsive: true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>maintainAspectRatio: false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>plugins: {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>legend: {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>labels: {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>color: '#e2e8f0'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderAdminDashboard() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const dashboardContent = document.getElementById('admin-dashboard-content');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dashboardContent.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (courses.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>dashboardContent.innerHTML = '&lt;p class="text-slate-400 text-center text-lg mt-8"&gt;No course data available.&lt;/p&gt;';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let totalPossibleEntriesOverall = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>let filledEntriesOverall = 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>courses.forEach(course =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const studentsInThisCourse = students.filter(s =&gt; s.gradeLevel === course.gradeLevel &amp;&amp; s.room === course.room);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let courseTotalPossibleEntries = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let courseFilledEntries = 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (course.assessmentComponents &amp;&amp; course.assessmentComponents.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>studentsInThisCourse.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>course.assessmentComponents.forEach(component =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>if (component.categories &amp;&amp; component.categories.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>component.categories.forEach(cat =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>if (cat.subItems &amp;&amp; cat.subItems.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>cat.subItems.forEach(sub =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                        </span>courseTotalPossibleEntries++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                        </span>if (s.scores[course.id]?.[component.name]?.[cat.name]?.[sub.id] !== undefined &amp;&amp; s.scores[course.id]?.[component.name]?.[cat.name]?.[sub.id] !== null &amp;&amp; !isNaN(s.scores[course.id]?.[component.name]?.[cat.name]?.[sub.id])) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                            </span>courseFilledEntries++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>courseTotalPossibleEntries++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>if (s.scores[course.id]?.[component.name]?.[cat.name] !== undefined &amp;&amp; s.scores[course.id]?.[component.name]?.[cat.name] !== null &amp;&amp; !isNaN(s.scores[course.id]?.[component.name]?.[cat.name])) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                        </span>courseFilledEntries++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>totalPossibleEntriesOverall += courseTotalPossibleEntries;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>filledEntriesOverall += courseFilledEntries;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const courseName = `${course.subject} (${course.gradeLevel}/${course.room}) - ${course.academicYear} ${course.semester}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const teacherName = course.teacher?.realName || 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let totalCourseScore = 0, gradedStudentsCount = 0, highestScoreInClass = 0, lowestScoreInClass = 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>let gradeCounts = { 'A+': 0, 'A': 0, 'A-': 0, 'B+': 0, 'B': 0, 'B-': 0, 'C+': 0, 'C': 0, 'C-': 0, 'D': 0, 'F': 0, 'N/A': 0 };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>studentsInThisCourse.forEach(s =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const { finalScore, grade } = calculateFinalScoreAndGrade(s, course);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const score = parseFloat(finalScore);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (grade !== 'N/A' &amp;&amp; !isNaN(score)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>totalCourseScore += score;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>gradedStudentsCount++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if(gradeCounts[grade] !== undefined) gradeCounts[grade]++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (score &gt; highestScoreInClass) highestScoreInClass = score;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>if (score &lt; lowestScoreInClass) lowestScoreInClass = score;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>gradeCounts['N/A']++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const averageCourseScore = gradedStudentsCount &gt; 0 ? (totalCourseScore / gradedStudentsCount) : 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const displayHighestScore = gradedStudentsCount &gt; 0 ? formatNumber(highestScoreInClass) : 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const displayLowestScore = gradedStudentsCount &gt; 0 ? formatNumber(lowestScoreInClass) : 'N/A';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const scoreEntryProgress = courseTotalPossibleEntries &gt; 0 ? (courseFilledEntries / courseTotalPossibleEntries) * 100 : 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>dashboardContent.innerHTML += `</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="p-6 rounded-lg border card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h4 class="text-xl font-semibold mb-2 text-blue-300"&gt;${courseName}&lt;/h4&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p class="text-slate-400 mb-4"&gt;Teacher: ${teacherName}&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;&lt;p class="text-sm text-slate-400"&gt;Total Courses&lt;/p&gt;&lt;p class="text-2xl font-bold text-white"&gt;${courses.length}&lt;/p&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;&lt;p class="text-sm text-slate-400"&gt;Total Students&lt;/p&gt;&lt;p class="text-2xl font-bold text-white"&gt;${students.length}&lt;/p&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div&gt;&lt;p class="text-sm text-slate-400"&gt;Active Teachers&lt;/p&gt;&lt;p class="text-2xl font-bold text-white"&gt;${new Set(courses.map(c =&gt; c.teacher?.realName).filter(name =&gt; name)).size}&lt;/p&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="mt-6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h5 class="font-semibold text-lg mb-2"&gt;Overall Score Entry Progress&lt;/h5&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="w-full bg-slate-700 rounded-full h-4"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-indigo-500 h-4 rounded-full" style="width: ${scoreEntryProgress}%"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p class="text-right text-sm text-slate-400 mt-1"&gt;${Math.round(scoreEntryProgress)}% Complete&lt;/p&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function showTab(tabName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('score-entry-section').classList.toggle('hidden', tabName !== 'score-entry');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('summary-section').classList.toggle('hidden', tabName !== 'summary');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('score-entry-tab').classList.toggle('active', tabName === 'score-entry');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('summary-tab').classList.toggle('active', tabName === 'summary');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAll();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function renderAll() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!isFirebaseReady || !activeCourse) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const info = document.getElementById('score-entry-info');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.textContent = 'Please select an Academic Year, Semester, Course, and save Teacher Info to begin.';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>info.classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('score-input-table').innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('summary-table').innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('summary-info').classList.remove('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderTeacherInfoSection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderAssessmentComponents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>updateCategoryManagementSectionState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (studentGroupChartInstance) studentGroupChartInstance.destroy();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.getElementById('advanced-dashboard').classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const totalCompWeightSpan = document.getElementById('current-total-grading-period-weight');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const compWarningDiv = document.getElementById('grading-period-warning');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (totalCompWeightSpan) totalCompWeightSpan.textContent = '0';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (compWarningDiv) compWarningDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const totalCatWeightSpan = document.getElementById('current-total-category-weight');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const catWarningDiv = document.getElementById('category-weight-warning');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (totalCatWeightSpan) totalCatWeightSpan.textContent = '0';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (catWarningDiv) catWarningDiv.classList.add('hidden');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderCategories();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderStudents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderTeacherInfoSection();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderAssessmentComponents();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateCategoryManagementSectionState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const activeTab = document.querySelector('.tab-button.active').id;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (activeTab === 'summary-tab') {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderSummary();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderScoresTable();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function setupEventListeners() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('select-academic-year').addEventListener('change', updateAcademicYearSelection);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('select-semester').addEventListener('change', updateSemesterSelection);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('select-subject').addEventListener('change', updateCourseSelection);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('select-grade-level').addEventListener('change', updateCourseSelection);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('select-room').addEventListener('change', updateCourseSelection);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('new-grading-period-name').addEventListener('keydown', (e) =&gt; { if (e.key === 'Enter') addGradingPeriod(); });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('new-grading-period-weight').addEventListener('keydown', (e) =&gt; { if (e.key === 'Enter') addGradingPeriod(); });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('new-category-name').addEventListener('keydown', (e) =&gt; { if(e.key === 'Enter') addCategory(); });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('new-category-weight').addEventListener('keydown', (e) =&gt; { if(e.key === 'Enter') addCategory(); });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('category-management-section').addEventListener('keydown', (e) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (e.key === 'Enter' &amp;&amp; e.target.id.startsWith('new-sub-item-name-')) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const catIndex = parseInt(e.target.id.replace('new-sub-item-name-', ''));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>addSubItem(catIndex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else if (e.key === 'Enter' &amp;&amp; e.target.id.startsWith('new-sub-item-max-score-')) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const catIndex = parseInt(e.target.id.replace('new-sub-item-max-score-', ''));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>addSubItem(catIndex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.querySelectorAll('.new-student-input').forEach(input =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>input.addEventListener('keydown', (e) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if(e.key === 'Enter' &amp;&amp; !document.getElementById('add-student-button').disabled) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>addStudent();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.querySelectorAll('.teacher-info-input').forEach(input =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>input.addEventListener('keydown', (e) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if(e.key === 'Enter' &amp;&amp; !document.getElementById('save-teacher-info-button').disabled) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>saveTeacherInfo();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('score-input-table').addEventListener('keydown', (e) =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (e.key === 'Enter' &amp;&amp; e.target.classList.contains('score-input')) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>e.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const inputs = Array.from(document.querySelectorAll('.score-input'));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const currentIndex = inputs.indexOf(e.target);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>const nextInput = inputs[currentIndex + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (nextInput) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>nextInput.focus();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                    </span>nextInput.select();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('admin-password-input').addEventListener('keydown', (e) =&gt; { if (e.key === 'Enter') { checkAdminPassword(); } });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('reset-password-input').addEventListener('keydown', (e) =&gt; { if (e.key === 'Enter') { confirmResetCourse(); } });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>document.getElementById('settings-logo-url').addEventListener('keydown', (e) =&gt; { if (e.key === 'Enter') { saveSettings(); } });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>window.onload = async function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setupEventListeners();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>populateDropdowns();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>await initializeFirebase();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</span></p>
<p class="p1"><span class="s1">&lt;/body&gt;</span></p>
<p class="p1"><span class="s1">&lt;/html&gt;</span></p>
</body>
</html>
